generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ---------------------------------------------------------------------------
// Enums
// ---------------------------------------------------------------------------

enum Role {
  ADMIN
  ORGANIZER
  VENDOR
}

enum EventStatus {
  DRAFT
  OPEN // accepting applications
  CLOSED // applications closed
  COMPLETED
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum VendorPriority {
  MUST_HAVE
  NICE_TO_HAVE
  BACKUP
}

enum MeetingStatus {
  PENDING
  CONFIRMED
  DECLINED
  CANCELLED
}

enum EquipmentSource {
  MUNICIPAL
  PARTNER_VENDOR
  PURCHASE
}

enum EquipmentReservationStatus {
  DRAFT
  REQUESTED
  CONFIRMED
  CANCELLED
}

enum VolunteerStatus {
  INVITED
  CONFIRMED
  DECLINED
  CANCELLED
}

enum NotificationChannel {
  EMAIL
  INSTAGRAM_DM
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

enum EventPhotoType {
  HERO
  VENUE
  MAP
  POSTER
  GALLERY
}

enum VendorPhotoType {
  LOGO
  SHOP
  PRODUCT
  MENU
  OTHER
}

// ---------------------------------------------------------------------------
// User  — minimal auth record; role-specific data lives in profile tables
// ---------------------------------------------------------------------------

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  passwordHash String
  role         Role     @default(VENDOR)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  organizerProfile OrganizerProfile?
  vendorProfile    VendorProfile?
  auditLogs        AuditLog[]
  meetingSlots     MeetingSlot[]
  oauthTokens      OAuthToken[]

  @@map("users")
}

// ---------------------------------------------------------------------------
// OrganizerProfile — extra fields for municipalities / facility owners
// ---------------------------------------------------------------------------

model OrganizerProfile {
  id               String   @id @default(cuid())
  organizationName String
  contactPhone     String?
  website          String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  events Event[]

  @@map("organizer_profiles")
}

// ---------------------------------------------------------------------------
// VendorProfile — shop / stall details
// ---------------------------------------------------------------------------

model VendorProfile {
  id           String   @id @default(cuid())
  shopName     String
  description  String?
  category     String? // e.g. "food", "crafts", "produce"
  contactPhone String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  applications  Application[]
  documents     Document[]
  photos        VendorPhoto[]
  vendorTargets VendorTarget[]
  meetingSlots  MeetingSlot[]
  notifications Notification[]

  @@map("vendor_profiles")
}

// ---------------------------------------------------------------------------
// Event — a market / fair that organizers publish
// ---------------------------------------------------------------------------

model Event {
  id          String      @id @default(cuid())
  title       String
  description String?
  location    String?
  eventDate   DateTime
  deadline    DateTime // application deadline
  status      EventStatus @default(DRAFT)
  maxVendors  Int?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  organizerId String
  organizer   OrganizerProfile @relation(fields: [organizerId], references: [id])

  applications Application[]
  auditLogs    AuditLog[]
  photos       EventPhoto[]

  // Planning & operations
  budgets           Budget[]
  vendorTargets     VendorTarget[]
  meetingSlots      MeetingSlot[]
  equipmentBookings EquipmentBooking[]
  staffingPlans     StaffingPlan[]
  volunteerInvites  VolunteerInvite[]
  salesRecords      SalesRecord[]
  weatherAlerts     WeatherAlert[]
  notifications     Notification[]
  chatThreads       ChatThread[]
  feedbacks         Feedback[]

  @@map("events")
}

// ---------------------------------------------------------------------------
// Application — a vendor applying to an event
// ---------------------------------------------------------------------------

model Application {
  id        String            @id @default(cuid())
  message   String? // cover note from vendor
  status    ApplicationStatus @default(PENDING)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  vendorId String
  vendor   VendorProfile @relation(fields: [vendorId], references: [id])

  eventId String
  event   Event  @relation(fields: [eventId], references: [id])

  auditLogs AuditLog[]

  @@unique([vendorId, eventId])
  @@map("applications")
}

// ---------------------------------------------------------------------------
// Document — file metadata (MVP stores path/URL only, no blob)
// ---------------------------------------------------------------------------

model Document {
  id        String   @id @default(cuid())
  fileName  String
  fileUrl   String // S3 / Vercel Blob URL
  mimeType  String?
  sizeBytes Int?
  createdAt DateTime @default(now())

  vendorId String
  vendor   VendorProfile @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model EventPhoto {
  id        String         @id @default(cuid())
  imageUrl  String
  fileName  String
  mimeType  String?
  sizeBytes Int?
  type      EventPhotoType @default(GALLERY)
  caption   String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId, type])
  @@map("event_photos")
}

model VendorPhoto {
  id        String          @id @default(cuid())
  imageUrl  String
  fileName  String
  mimeType  String?
  sizeBytes Int?
  type      VendorPhotoType @default(PRODUCT)
  caption   String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  vendorId String
  vendor   VendorProfile @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId, type])
  @@map("vendor_photos")
}

// ---------------------------------------------------------------------------
// AuditLog — immutable record of organizer decisions
// ---------------------------------------------------------------------------

model AuditLog {
  id        String   @id @default(cuid())
  action    String // e.g. "APPLICATION_ACCEPTED", "EVENT_PUBLISHED"
  details   String?
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  eventId String?
  event   Event?  @relation(fields: [eventId], references: [id])

  applicationId String?
  application   Application? @relation(fields: [applicationId], references: [id])

  notificationId String?
  notification   Notification? @relation(fields: [notificationId], references: [id])

  @@map("audit_logs")
}

// ---------------------------------------------------------------------------
// Budget — planned vs actual for an event
// ---------------------------------------------------------------------------

model Budget {
  id         String   @id @default(cuid())
  category   String // e.g. venue, equipment, staffing, marketing
  plannedYen Int
  actualYen  Int?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("budgets")
}

// ---------------------------------------------------------------------------
// VendorTarget — desired vendors with priority & status
// ---------------------------------------------------------------------------

model VendorTarget {
  id         String         @id @default(cuid())
  vendorName String // if linked to existing profile, also store vendorProfileId
  priority   VendorPriority
  status     String? // e.g. CONTACTED, MEETING_PENDING, CONFIRMED
  notes      String?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  vendorProfileId String?
  vendorProfile   VendorProfile? @relation(fields: [vendorProfileId], references: [id])

  meetingSlots    MeetingSlot[]
  meetingInvites  MeetingInvite[]

  @@map("vendor_targets")
}

// ---------------------------------------------------------------------------
// MeetingSlot — scheduling slots tied to vendor targets and organizers
// ---------------------------------------------------------------------------

model MeetingSlot {
  id        String        @id @default(cuid())
  start     DateTime
  end       DateTime
  status    MeetingStatus @default(PENDING)
  source    String? // e.g. GOOGLE_CAL, MANUAL_NOTE
  notes     String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  vendorTargetId String?
  vendorTarget   VendorTarget? @relation(fields: [vendorTargetId], references: [id])

  organizerId String? // organizer user id for personal calendar linkage
  organizer   User?   @relation(fields: [organizerId], references: [id])

  vendorProfileId String?
  vendorProfile   VendorProfile? @relation(fields: [vendorProfileId], references: [id])

  @@index([eventId])
  @@index([vendorTargetId])
  @@map("meeting_slots")
}

// ---------------------------------------------------------------------------
// EquipmentBooking — municipal/partner gear reservations
// ---------------------------------------------------------------------------

model EquipmentBooking {
  id         String                     @id @default(cuid())
  itemName   String
  quantity   Int                        @default(1)
  source     EquipmentSource
  status     EquipmentReservationStatus @default(DRAFT)
  costYen    Int?
  vendorName String?
  notes      String?
  neededDate DateTime?
  createdAt  DateTime                   @default(now())
  updatedAt  DateTime                   @updatedAt

  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  catalogItemId String?
  catalogItem   EquipmentCatalog? @relation(fields: [catalogItemId], references: [id])

  @@map("equipment_bookings")
}

// ---------------------------------------------------------------------------
// EquipmentCatalog — available equipment items from municipal or partner vendors
// ---------------------------------------------------------------------------

model EquipmentCatalog {
  id          String          @id @default(cuid())
  name        String
  category    String
  source      EquipmentSource
  priceYen    Int             @map("price_yen")
  vendorName  String?         @map("vendor_name")
  description String?
  imageUrl    String?         @map("image_url")
  isActive    Boolean         @default(true) @map("is_active")
  createdAt   DateTime        @default(now()) @map("created_at")

  bookings EquipmentBooking[]

  @@map("equipment_catalog")
}

// ---------------------------------------------------------------------------
// StaffingPlan — staffing requirement per role/time block
// ---------------------------------------------------------------------------

model StaffingPlan {
  id        String   @id @default(cuid())
  role      String // e.g. setup, cashier, cleanup
  headcount Int
  start     DateTime
  end       DateTime
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("staffing_plans")
}

// ---------------------------------------------------------------------------
// VolunteerInvite — volunteer roster and status
// ---------------------------------------------------------------------------

model VolunteerInvite {
  id        String          @id @default(cuid())
  email     String
  name      String?
  status    VolunteerStatus @default(INVITED)
  notes     String?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("volunteer_invites")
}

// ---------------------------------------------------------------------------
// SalesRecord — per-vendor sales capture (QR/PayPay etc.)
// ---------------------------------------------------------------------------

model SalesRecord {
  id              String   @id @default(cuid())
  vendorName      String
  vendorProfileId String?
  amountYen       Int
  paymentMethod   String? // e.g. PayPay, cash
  note            String?
  recordedAt      DateTime @default(now())

  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("sales_records")
}

// ---------------------------------------------------------------------------
// WeatherAlert — cached forecast snapshot for event day
// ---------------------------------------------------------------------------

model WeatherAlert {
  id         String   @id @default(cuid())
  summary    String
  riskLevel  String? // e.g. LOW, MEDIUM, HIGH
  source     String? // API name
  capturedAt DateTime @default(now())

  eventId String @unique
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("weather_alerts")
}

// ---------------------------------------------------------------------------
// Notification — outbound communication queue
// ---------------------------------------------------------------------------

model Notification {
  id        String              @id @default(cuid())
  channel   NotificationChannel
  status    NotificationStatus  @default(PENDING)
  toAddress String
  subject   String?
  body      String
  metadata  Json?
  sentAt    DateTime?
  error     String?
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  eventId String?
  event   Event?  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  vendorProfileId String?
  vendorProfile   VendorProfile? @relation(fields: [vendorProfileId], references: [id])

  auditLogs AuditLog[]

  @@index([eventId])
  @@index([vendorProfileId])
  @@map("notifications")
}

// ---------------------------------------------------------------------------
// OAuthToken — external provider tokens (e.g., Google Calendar)
// ---------------------------------------------------------------------------

model OAuthToken {
  id           String    @id @default(cuid())
  provider     String
  scope        String?
  accessToken  String
  refreshToken String?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, userId])
  @@index([userId])
  @@map("oauth_tokens")
}

// ---------------------------------------------------------------------------
// ChatThread — conversation thread per event for AI workflow assistant
// ---------------------------------------------------------------------------

model ChatThread {
  id        String        @id @default(cuid())
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  messages ChatMessage[]

  @@index([eventId])
  @@map("chat_threads")
}

// ---------------------------------------------------------------------------
// ChatMessage — individual message in a chat thread
// ---------------------------------------------------------------------------

model ChatMessage {
  id        String   @id @default(cuid())
  role      String   // "user" | "assistant" | "system"
  content   String
  metadata  Json?    // tool calls, action results, etc.
  createdAt DateTime @default(now())

  threadId String
  thread   ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@map("chat_messages")
}

// ---------------------------------------------------------------------------
// MeetingInvite — token-based meeting invitation for vendors
// ---------------------------------------------------------------------------

model MeetingInvite {
  id          String    @id @default(cuid())
  token       String    @unique @default(cuid())
  expiresAt   DateTime  @map("expires_at")
  respondedAt DateTime? @map("responded_at")
  selectedSlotId String? @map("selected_slot_id")
  createdAt   DateTime  @default(now()) @map("created_at")

  vendorTargetId String
  vendorTarget   VendorTarget @relation(fields: [vendorTargetId], references: [id], onDelete: Cascade)

  @@index([vendorTargetId])
  @@map("meeting_invites")
}

// ---------------------------------------------------------------------------
// Feedback — post-event reviews and comments
// ---------------------------------------------------------------------------

model Feedback {
  id         String   @id @default(cuid())
  content    String
  authorName String?  @map("author_name")
  rating     Int?     // 1-5
  isPublic   Boolean  @default(false) @map("is_public")
  createdAt  DateTime @default(now()) @map("created_at")

  eventId String @map("event_id")
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  authorId String? @map("author_id")

  @@index([eventId])
  @@map("feedbacks")
}
